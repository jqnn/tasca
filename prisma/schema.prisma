generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int                @id @default(autoincrement())
  userName         String             @unique
  displayName      String?
  password         String?
  authMethodId     Int
  authMethod       AuthMethod         @relation(fields: [authMethodId], references: [id])
  role             Role               @default(USER)
  createdAt        DateTime           @default(now())
  ProjectMembers   ProjectMembers[]
  Project          Project[]
  Template         Template[]
  TaskInstance     InstanceTask[]
  TemplateInstance InstanceTemplate[]
}

model AuthMethod {
  id            Int            @id @default(autoincrement())
  type          AuthMethodType @default(LOCAL)
  description   String         @unique
  controllers   String?
  baseDN        String?
  securityType  SecurityType?  @default(NONE)
  port          Int?           @default(389)
  userName      String?
  password      String?
  usersDN       String?
  uidAttribute  String?
  accountSuffix String?
  User          User[]
}

model Project {
  id             Int              @id @default(autoincrement())
  name           String
  description    String?
  ownerId        Int
  owner          User             @relation(fields: [ownerId], references: [id])
  createdAt      DateTime         @default(now())
  ProjectMembers ProjectMembers[]
}

model ProjectMembers {
  userId    Int
  projectId Int
  joinedAt  DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  project Project @relation(fields: [projectId], references: [id])

  @@id([userId, projectId])
}

model Template {
  id               Int                @id @default(autoincrement())
  name             String
  description      String?
  createdById      Int
  createdBy        User               @relation(fields: [createdById], references: [id])
  createdAt        DateTime           @default(now())
  TemplateTask     TemplateTask[]
  TemplateField    TemplateField[]
  TemplateInstance InstanceTemplate[]
}

model TemplateField {
  id            Int             @id @default(autoincrement())
  label         String
  placeHolder   String?
  fieldType     FieldType       @default(TEXT)
  order         Int
  templateId    Int
  template      Template        @relation(fields: [templateId], references: [id], onDelete: Cascade)
  FieldInstance InstanceField[]
}

model TemplateTask {
  id           Int            @id @default(autoincrement())
  task         String
  description  String
  order        Int
  templateId   Int
  template     Template       @relation(fields: [templateId], references: [id], onDelete: Cascade)
  TaskInstance InstanceTask[]
}

model InstanceTemplate {
  id            Int             @id @default(autoincrement())
  templateId    Int
  template      Template        @relation(fields: [templateId], references: [id])
  createdAt     DateTime        @default(now())
  createdById   Int
  createdBy     User            @relation(fields: [createdById], references: [id])
  status        InstanceStatus  @default(OPEN)
  TaskInstance  InstanceTask[]
  FieldInstance InstanceField[]
}

model InstanceField {
  id         Int              @id @default(autoincrement())
  value      String
  updatedAt  DateTime         @default(now())
  fieldId    Int
  field      TemplateField    @relation(fields: [fieldId], references: [id])
  instanceId Int
  instance   InstanceTemplate @relation(fields: [instanceId], references: [id])
}

model InstanceTask {
  id         Int              @id @default(autoincrement())
  updatedAt  DateTime         @default(now())
  status     InstanceStatus   @default(OPEN)
  taskId     Int
  task       TemplateTask     @relation(fields: [taskId], references: [id])
  instanceId Int
  instance   InstanceTemplate @relation(fields: [instanceId], references: [id])
  userId     Int?
  User       User?            @relation(fields: [userId], references: [id])
}

enum Role {
  ADMINISTRATOR
  OPERATOR
  USER
}

enum AuthMethodType {
  LOCAL
  AD
  LDAP
}

enum SecurityType {
  NONE
  TLS
  SSL
}

enum FieldType {
  TEXT
  NUMBER
}

enum InstanceStatus {
  OPEN
  COMPLETED
}
